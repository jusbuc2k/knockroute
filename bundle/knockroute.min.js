(function(n,t){"use strict";function v(){t.route=i;t.bindingHandlers.routeTemplate=a}function h(n,t){return(n.getAttribute(t)||"").toLowerCase().trim()==="true"}function y(n){return n==null?null:n[0]===":"?e.dataType(n.slice(1)):n[0]==="="?e.equals(n.slice(1)):null}function u(n,t){this.requiredCount=n;this.hitCount=0;this.callbacks=[];this.state="pending";this.context=t}function r(n,t){var u=this;t=this.options=i.utils.defaults({pathSeperator:"/"},t||{});this.routeTemplate=n;this.segments=r.parseTemplate(n,t.pathSeperator)}function k(){function r(){var t=n.getPath();n.pathChanged.notifySubscribers(t);u=t}var n=this,u="";n.pathChanged=new t.subscribable;n.setPath=function(t){window.location.hash=t?n.decorate(t):""};n.getPath=function(){return window.location.hash.slice(1)};n.decorate=function(n){return n.indexOf("#/")===0?n:n[0]==="/"?"#"+n:n[0]==="#"?"#/"+n.slice(1):"#/"+n};n.start=function(){i.utils.attachEvent(window,"hashchange",r);r()};n.stop=function(){i.utils.detachEvent(window,"hashchange",r)};n.revert=function(t){n.setPath(u);typeof t=="function"&&window.setTimeout(t,20)}}function c(n){function e(t){var r=new RegExp(n.basePath,"gi"),i;return(i=r.exec(t))?i[0]:""}function o(t){var r=new RegExp(n.basePath,"gi"),i;return(i=r.exec(t))?t.substr(i[0].length):t}function u(){var n=r.getPath();r.pathChanged.notifySubscribers(n);f=n}var r=this,f="";n=i.utils.defaults({basePath:"^"},n||{});r.pathChanged=new t.subscribable;r.setPath=function(n){window.history.pushState({},"",e(window.location.pathname)+n);r.pathChanged.notifySubscribers(n)};r.getPath=function(){return o(window.location.pathname)};r.decorate=function(n){return n};r.start=function(){i.utils.attachEvent(window,"popstate",u);u()};r.stop=function(){i.utils.detachEvent(window,"popstate",u)};r.revert=function(n){r.setPath(f);window.setTimeout(n,20)}}function l(){var n=this}function o(){var n=this}function s(n){var t=this;if(this.options=i.utils.defaults({createTemplates:!0,templateContainer:null,cache:!0},n||{}),typeof jQuery=="undefined")throw"jQuery is required to use the DomTemplateProvider";}function d(n){var i=this;this.name=n;this.bus=t.subscribable()}function f(n){var r=this;t.utils.extend(r,i.utils.defaults({name:null,views:[]},n||{}))}function g(n){var r=this,u={name:null,area:null,model:null,modelInstance:null,templateID:null,activeTemplateID:t.observable(null),templateSrc:null,templatePersist:!1,singleton:!1,errorContent:null};t.utils.extend(r,i.utils.defaults(u,n||{}))}function nt(n){function y(n,t,i){var f,u=n.templateID,e,o=!0,s={cancel:function(){},setTemplate:function(n){if(o)u=n;else throw"Template cannot be set at this time.";}};return f=n.modelInstance&&typeof n.modelInstance[t]=="function"?Promise.resolve(n.modelInstance[t].apply(n.modelInstance,[i,s])):Promise.resolve(null),o=!1,e=r.getTemplate(u,n),Promise.all([f,r.templateProvider.loadTemplate(e).then(function(){n.activeTemplateID(u)})])}function d(n,t){function i(){(t||!n.singleton)&&(n.modelInstance!=null&&typeof n.modelInstance.dispose=="function"&&n.modelInstance.dispose.apply(n.modelInstance),n.modelInstance=null)}return n.modelInstance!=null&&typeof n.modelInstance.unload=="function"?Promise.resolve(n.modelInstance.unload.apply(n.modelInstance,[t])).then(i):(i(),Promise.resolve(!0))}function g(t,u,e){var s,h=[];o&&o.abort("abort");o=i.utils.abortable(function(){f(t);o=null;r.onLoaded.notifySubscribers({routeValues:u,context:this})});s=t.modelInstance||t.model||{};r.onLoading.notifySubscribers({routeValues:u,context:this});t.modelInstance=typeof s=="function"?r.modelFactory.createModel(s,[r,u]):s;try{h.push(d(f(),!1).then(function(n){n===!1&&e();f().activeTemplateID()&&f().activeTemplateID()!==t.templateID&&r.templateProvider.unloadTemplate(f().activeTemplateID())}));h.push(y(t,n.loadMethodName,u).then(function(){return y(t,n.updateMethodName,u)}))}catch(c){return v("Error",n.errorTemplateID,c,u),Promise.reject(c)}return Promise.all(h).then(o).catch(function(t){o=null;t!=="abort"&&v("Error",n.errorTemplateID,t,u)})}function nt(n){var t;return t=typeof n=="string"?r.getTemplate(n):n,r.templateProvider.loadTemplate(t)}function tt(t){for(var c,s,f,h,e={area:null,view:null,routeValues:null},o=0;o<u.length;o++)if(f=u[o].route.match(t,u[o].defaults)){if(s=f[n.areaRouteKey]?r.getView(f[n.viewRouteKey],f[n.areaRouteKey]):r.getView(f[n.viewRouteKey]),s==null)continue;e.area=c;e.view=s;break}return f==null||e.view==null?null:(h=i.utils.parseQueryString(t),f=i.utils.defaults(h,f),e.routeValues=f,e)}function v(t,u,e,o){var s=new i.View({name:t,modelInstance:{name:t,routeValues:o,error:e},errorContent:null}),h,c={routeValues:o,context:this,error:e,errorHandled:!1};r.onLoadError.notifySubscribers(c);!c.errorHandled&&u?(h=r.getTemplate(u,{templateID:u}),typeof n.errorModel=="function"&&(s.modelInstance=new n.errorModel(o,e)),nt(h).then(function(){s.activeTemplateID(h.templateID);f(s)},function(){s.errorContent="Failed to load the error template.";f(s)})):c.errorHandled||(s.errorContent="An error occurred while loading the view.",f(s))}function it(t){var i=tt(t);if(i==null){if(n.notFoundTemplateID){v("NotFound",n.notFoundTemplateID,"Path not found");return}throw"Path not found";}i.view===f()?y(i.view,n.updateMethodName,i.routeValues).catch(function(t){v("Error",n.errorTemplateID,t,i.routeValues)}):g(i.view,i.routeValues,function(){r.pathProvider.stop();r.pathProvider.revert(function(){r.pathProvider.start()})})}function k(){var s,f,o,r;if(!e){for(i.utils.clearArray(u),r=0;r<n.routes.length;r++)u.push({route:new i.Route(n.routes[r].template),defaults:n.routes[r].defaults});if(n.areas&&n.areas.length){for(i.utils.clearArray(h),f=[],r=0;r<n.areas.length;r++)for(s=new i.Area(n.areas[r]),h.push(s),o=0;o<u.length;o++)f.push({template:"{area="+s.name+"}/"+u[o].route.routeTemplate,defaults:t.utils.extend({area:s.name},u[o].defaults)});for(r=0;r<f.length;r++)u.push({route:new i.Route(f[r].template),defaults:f[r].defaults})}p=!0}}function rt(){if(!e){var t;if(r.pathProvider.stop(),k(),n.views&&n.views.length)for(i.utils.clearArray(c),t=0;t<n.views.length;t++)ut(n.views[t]);else throw"ViewRouter could not be initialized because no views are defined.";if(n.templates&&n.templates.length)for(i.utils.clearArray(a),t=0;t<n.templates.length;t++)a.push(n.templates[t]);s||(s=r.pathProvider.pathChanged.subscribe(it),r.pathProvider.start());e=!0}}function ut(n){var t,u;if(t=n instanceof i.View?n:new i.View(n),t.area==null)c.push(t);else{if(u=r.getArea(t.area),u==null)throw"Invalid area name on view";u.addView(t)}}var r=this;n=i.utils.defaults({routes:[{template:"{view}/{id?}",defaults:{view:"home"}}],viewRouteKey:"view",areaRouteKey:"area",loadMethodName:"load",updateMethodName:"update",areas:[],views:[],templates:[],pathProvider:"hash",templateProvider:"default",errorTemplateID:"",notFoundTemplateID:"",defaultTemplateID:"",errorModel:null},n||{});var e=!1,p=!1,w=new i.View({name:null,templateID:n.defaultTemplateID}),u=[],h=[],c=[],a=[],s,o=null,f=t.observable(w);r.pathProvider=new i.HashPathStringProvider;r.templateProvider=new i.DefaultTemplateProvider;r.modelFactory=new l;r.dispose=function(){r.pathProvider.stop();for(var n=0;n<r.views.length;n++)r.views[n].unloadModel(!0);s&&(s.dispose(),s=null)};r.getArea=function(n){return t.utils.arrayFirst(h,function(t){return t.name===n})};r.getView=function(n,i){var u;return arguments.length===1?t.utils.arrayFirst(c,function(t){return t.name===n}):arguments.length===2?(u=r.getArea(i),u==null)?null:u.getView(n):null};r.getTemplate=function(n,i){var r=t.utils.arrayFirst(a,function(t){return t.templateID===n});return r?r:i};r.resolve=function(t){for(var e,c=r.pathProvider.getPath(),h="",l={},a=!1,v,o,s,f=0;f<u.length;f++)if(v=u[f].route.resolve(t,c)){if(o=u[f].route,s=u[f].defaults,t[n.areaRouteKey]&&(!s[n.areaRouteKey]||!r.getArea(s[n.areaRouteKey])))continue;break}if(o==null)throw"No matching route for current path.";for(e in t)t.hasOwnProperty(e)&&!o.hasKey(e)&&(l[e]=t[e],a=!0);return i.utils.defaults(s,t),h+=o.resolve(t,c),a&&(h+=b+i.utils.serializeQueryString(l)),this.pathProvider.decorate(h)};r.navigate=function(n){var t;if(t=typeof n=="string"?n:r.resolve(n),t!=null)r.pathProvider.setPath(t);else throw"No matching route or path exists.";};r.setTemplate=function(n){f().activeTemplateID(n)};r.addViews=function(t){var i;if(e)throw"Views cannot be added once the router is initalized";if(t&&t.length)for(i=0;i<t.length;i++)n.views.push(t[i])};r.insertRoutes=function(t){if(p)throw"Routes cannot be added once the router is initalized";var i;if(t&&t.length)for(i=0;i<t.length;i++)n.routes.splice(0,0,t[i])};r.addRoutes=function(t){if(e)throw"Routes cannot be added once the router is initalized";var i;if(t&&t.length)for(i=0;i<t.length;i++)n.routes.push(t[i])};r.insertRoutes=function(t){if(e)throw"Routes cannot be added once the router is initalized";var i;if(t&&t.length)for(i=0;i<t.length;i++)n.routes.splice(0,0,t[i])};r.clearRoutes=function(){if(e)throw"Routes cannot be modified once the router is initalized";i.utils.clearArray(n.routes)};r.destroy=function(){r.pathProvider.stop();i.utils.clearArray(u);i.utils.clearArray(h);i.utils.clearArray(c);i.utils.clearArray(a);f(w)};r.init=rt;r.initRoutes=k;r.view=t.computed(function(){return f()});r.onLoading=new t.subscribable;r.onLoaded=new t.subscribable;r.onLoadError=new t.subscribable;typeof n.templateProvider=="object"?r.templateProvider=n.templateProvider:n.templateProvider==="ajax"&&(r.templateProvider=new i.AjaxTemplateProvider);typeof n.pathProvider=="object"?r.pathProvider=n.pathProvider:n.pathProvider==="history"&&(r.pathProvider=new i.HistoryPathStringProvider(n.basePath))}var i={},e,a;i.utils=i.utils||{};i.utils.clearArray=function(n){while(n.length>0)n.pop()};i.utils.defaults=function(n,t){for(var i in n)t.hasOwnProperty(i)||typeof t[i]!="undefined"||typeof n[i]=="undefined"||(t[i]=n[i]);return t};i.utils.parseQueryString=function(n){var u={},f=(n||"").indexOf("?"),e=0,r,t,i;if(f>=0&&(n=n.slice(f+1)),typeof n!="undefined")for(r=n.split("&"),i=0;i<r.length;i++)t=r[i].split("="),t.length===2&&(u[t[0]]=t[1],e++);return e>0?u:null};i.utils.serializeQueryString=function(n){var i=[];for(var t in n)n.hasOwnProperty(t)&&i.push(t+"="+n[t]);return i.join("&")};i.utils.nowOrThen=function(n){return new Promise(function(t,i){typeof n=="boolean"?n?t(n):i(n):n!=null&&typeof n.done=="function"?n.done(function(){t(arguments)}).fail(function(){i(arguments)}):n!=null&&typeof n.then=="function"?n.then(t,i):n!=null?t(n):t()})};i.utils.attachEvent=function(n,t,i){if(n.addEventListener)n.addEventListener(t,i,!1);else if(n.attachEvent)n.attachEvent("on"+t,i);else throw"No event subscription method available.";};i.utils.detachEvent=function(n,t,i){if(n.removeEventListener)n.removeEventListener(t,i,!1);else if(n.detachEvent)n.detachEvent("on"+t,i);else throw"No event subscription method available.";};i.utils.abortable=function(n){function i(){return t?Promise.reject(t):Promise.resolve(n.apply(this,arguments))}var t=null;return i.abort=function(n){t=n},i};i.utils.setTextContent=function(n,i){var r=t.utils.unwrapObservable(i),u;(r===null||r===undefined)&&(r="");u=t.virtualElements.firstChild(n);!u||u.nodeType!=3||t.virtualElements.nextSibling(u)?t.virtualElements.setDomNodeChildren(n,[document.createTextNode(r)]):u.data=r;t.utils.forceRefresh(n)};e={equals:function(n){return function(t){return n===t}},dataType:function(n){var t=/.*/;return n==="float"?t=/^[-+]?\d*\.?\d*$/i:n==="int"?t=/^[-+]?\d*$/i:n==="hex"&&(t=/^[a-fA-F0-9]*$/i),function(n){return t.test(n)}}};u.prototype.hit=function(){var n;if(this.hitCount++,this.hitCount>=this.requiredCount&&this.state==="pending")for(this.state="resolved",n=0;n<this.callbacks.length;n++)typeof this.callbacks[n][0]=="function"&&this.callbacks[n][0].call(this.context)};u.prototype.reject=function(){for(var n=0;n<this.callbacks.length;n++)typeof this.callbacks[n][1]=="function"&&this.callbacks[n][1].call(this.context)};u.prototype.then=function(n,t){this.state==="pending"?this.callbacks.push([n,t]):this.state==="resolved"&&typeof n=="function"?n.call(this.context):this.state==="rejected"&&typeof t=="function"&&t.call(this.context)};u.prototype.abort=function(){this.state="aborted"};var p="\\{(\\w+)([=:]\\w+)?(\\??)\\}",w=/^[\w\+\.\-\~]+$/i,b="?";r.parseSegmentValue=function(n,t){switch(t){case"float":return parseFloat(n);case"int":return parseInt(n,10);case"hex":return parseInt(n,16);default:return n}};r.parseTemplate=function(n,t){var f=[],r,o=!1,i,h,u,c,e,s;for(n.indexOf(t)===0&&(n=n.slice(t.length)),r=n.split(t),i=0;i<r.length;i++)if(r[i]){for(u=[],c=new RegExp(p,"gi");h=c.exec(r[i]);)u.push(h);if(u.length===1){if(e=!1,s=u[0][2]&&u[0][2][0]===":"?u[0][2].slice(1):"string",s==="params"?(f.push({value:r[i],parts:[{name:u[0][1],optional:!0,type:"params",dataType:"string"}]}),e=!0):f.push({value:r[i],parts:[{name:u[0][1],optional:e=u[0][3]==="?",type:"parameter",constraint:y(u[0][2]),dataType:s}]}),o&&!e)throw"Invalid route template: A required segment cannot follow an optional one.";o=o||e}else if(u.length>1)throw"Invalid route template: Multi-part route segments are not implemented";else if(w.test(r[i]))f.push({value:r[i],parts:[{name:r[i],optional:!1,type:"literal"}]});else if(r[i]==="*")f.push({value:r[i],parts:[{name:r[i],optional:!1,type:"wildcard",dataType:"string"}]});else throw"Invalid route template: The segment value '"+r[i]+"' is invalid.";}return f};r.prototype.match=function(n,t){var s,o,f,e={},l,u,i,c,h;if(n==null)throw"A value for path must be specified.";for(n.indexOf(this.options.pathSeperator)===0&&(n=n.slice(this.options.pathSeperator.length)),l=-1,(l=n.indexOf("?"))>=0&&(n=n.slice(0,l)),s=n.split(this.options.pathSeperator),u=0;u<s.length;u++)if(o=s[u],f=this.segments.length>u?this.segments[u]:null,f==null){if(o.length>0)return null}else if(f.parts.length===1){if(i=f.parts[0],i.type==="literal"){if(i.name!==o)return null}else if(i.type!=="wildcard")if(i.type==="parameter"&&o.length>0)if(i.constraint==null||i.constraint(o))e[i.name]=r.parseSegmentValue(o,i.dataType);else return null;else if(i.type==="parameter"){if(t&&(c=t[i.name]))e[i.name]=c;else if(!i.optional)return null}else if(i.type==="params"&&this.segments.length-1==u){e[i.name]=s.slice(u);break}else return null}else throw"Multi-part route segments are not implemented";for(u=s.length;u<this.segments.length;u++){if((f=this.segments[u],f.parts.length>1)||(i=f.parts[0],i.type==="literal"))return null;if(t&&(c=t[i.name])||i.type==="wildcard")e[i.name]=c;else if(!i.optional)return null}if(t!=null)for(h in t)t.hasOwnProperty(h)&&!e.hasOwnProperty(h)&&(e[h]=t[h]);return e};r.prototype.resolve=function(n,t){var u=[],o,r,s,i,f,e,h;for(t!=null&&(t[0]===this.options.pathSeperator&&(t=t.slice(1)),o=t.split(this.options.pathSeperator)),f=0;f<this.segments.length;f++)if(s=this.segments[f],r=o?o[f]:null,s.parts.length===1)if(i=s.parts[0],i.type==="wildcard")if(r&&r.length>0)u.push(r);else return null;else if(i.type==="literal")u.push(i.name);else if(i.type==="parameter"){if(n.hasOwnProperty(i.name))u.push(n[i.name]);else if(r&&r.length>0&&(i.constraint==null||i.constraint(r)))u.push(r);else if(!i.optional)return null}else i.type==="params"&&f==this.segments.length-1&&(e=n[i.name],e&&(e=e.join(this.options.pathSeperator),e.length&&u.push(e)));else throw"Multi-part route segments are not supported.";return(h=this.segments.reduce(function(n,t){return t.parts[0].optional?n:n+1},0),u.length<h)?null:u.join(this.options.pathSeperator)};r.prototype.hasKey=function(n){for(var i,t=0;t<this.segments.length;t++)for(i=0;i<this.segments[t].parts.length;i++)if(this.segments[t].parts[i].name===n)return!0;return!1};i.Route=r;i.HashPathStringProvider=k;i.HistoryPathStringProvider=c;l.prototype.createModel=function(n,t){function i(){return n.apply(this,t)}if(typeof n=="function")return i.prototype=n.prototype,new i;throw"constructor must be a valid constructor function.";};i.HistoryPathStringProvider=c;o.prototype.loadTemplate=function(n){var t=window.document.getElementById(n.templateID);if(!t)throw"There is no element with id "+n.templateID+".";if(t.tagName.toLowerCase()!=="script")throw"The element with id "+n.templateID+" must be a <script> tag in order to use it as a template.";return new Promise(function(n){n({success:!0,statusCode:203,template:t})})};o.prototype.unloadTemplate=function(){};i.DefaultTemplateProvider=o;s.prototype.loadTemplate=function(n){var t=window.document.getElementById(n.templateID),u=this.options.templateContainer||window.document.body,f=this;if(this.options.createTemplates&&!t&&n.templateSrc)t=window.document.createElement("script"),t.type="text/html",t.id=n.templateID,this.options.cache?t.setAttribute("data-src",n.templateSrc+"?v="+(new Date).getTime().toString()):t.setAttribute("data-src",n.templateSrc),n.templatePersist&&t.setAttribute("data-persist","true"),u.appendChild(t);else if(!t)throw"There is no template defined with id '"+n.templateID+"'";if(t.tagName.toLowerCase()!=="script")throw"The element with id "+n.templateID+" must be a <script> tag in order to use it as a template.";var r=n.templateSrc||t.getAttribute("data-src"),e=h(t,"data-loaded"),i={success:!1,statusCode:0,template:t};return new Promise(function(n,u){r&&!e?(f.options.cache||(r+="?v="+(new Date).getTime().toString()),jQuery.get(r).done(function(r,u,f){t.text=r;t.setAttribute("data-loaded","true");i.success=!0;i.statusCode=f.status;n(i)}).fail(function(n){i.success=!1;i.statusCode=n.status;u(i)})):(i.success=!0,i.statusCode=203,n(i))})};s.prototype.unloadTemplate=function(n){if(typeof n=="string"&&(n=window.document.getElementById(n)),!(n instanceof HTMLScriptElement))throw"The 'template' parameter must be an element ID or an HTMLScriptElement";h(n,"data-persist")||n.getAttribute("data-src")==null||(n.setAttribute("data-loaded","false"),n.text="")};typeof jQuery!="undefined"&&(i.AjaxTemplateProvider=s);i.Channel=d;f.prototype.getView=function(n){return t.utils.arrayFirst(this.views,function(t){return t.name===n})};f.prototype.addView=function(n){this.views.push(n)};f.prototype.clearViews=function(){i.utils.clearArray(this.views)};i.Area=f;i.View=g;i.ViewRouter=nt;a={init:function(n,r,u,f,e){var s=t.bindingHandlers.template.init(n,function(){return""}),o=t.utils.unwrapObservable(r()),h=t.computed(function(){var r=o.view(),s,c=function(){return s},h;if(r){if(r.errorContent){h=r.modelInstance&&r.modelInstance.error&&r.modelInstance.error.stack?r.modelInstance.error.stack:null;t.utils.setHtml(n,"<h2>Error<\/h2><p>"+r.errorContent+"<\/p><p>"+h+"<\/p>");return}}else{t.utils.setHtml(n,"<h2>Error<\/h2><p>Something went wrong when trying to display content.<\/p>");return}s={data:r.modelInstance,name:t.unwrap(r.activeTemplateID)||r.templateID};s.data&&s.name?t.bindingHandlers.template.update(n,c,u,f,e):t.utils&&t.utils.setTextContent?i.utils.setTextContent(n,"Loading..."):n.innerHTML&&(n.innerHTML="Loading...")}).extend({rateLimit:10});return o.init(),t.utils.domNodeDisposal.addDisposeCallback(n,function(){h.dispose()}),s},update:function(){}};v()})(window,ko);